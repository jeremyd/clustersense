#!/usr/bin/ruby

require 'rubygems'
require 'bundler/setup'

version = ">= 0"

if ARGV.first
  str = ARGV.first
  str = str.dup.force_encoding("BINARY") if str.respond_to? :force_encoding
  if str =~ /\A_(.*)_\z/
    version = $1
    ARGV.shift
  end
end

gem 'ami-agents', version
load Gem.bin_path('ami-agents', 'ami-agents', version)

@@trollop_options = Trollop::options do
  opt :list, "List available ami-agents.", :default => false
  opt :agent, "Name of ami-agent to startup.", :type => :string, :default => nil 
  opt :config, "Name of config file.yml located *in the config directory. (relative name)", :type => :string, :default => nil 
end

if @@trollop_options[:list]
# do the list and exit
  paths = Dir.glob("#{AmiAgents::AGENTS_DIR}/**/*.rb")
  strip_names = paths.collect do |path|
    p = File.basename(path)
    p.gsub(/\.rb/,"")
  end
  say "The following ami-agents are available:"
  strip_names.reject! { |r| r == "version" }
  puts strip_names
  exit 0
end

@@config_file = @@trollop_options[:config] || "config.yml"

Trollop::die("--agent <name> must be specified!") unless @@trollop_options[:agent]

begin
  require "ami-agents/#{@@trollop_options[:agent]}"
rescue => e
  Trollop::die("Failed to load #{@@trollop_options[:agent]} with error: #{e}")
end
say "#{@@trollop_options[:agent]} starting."
